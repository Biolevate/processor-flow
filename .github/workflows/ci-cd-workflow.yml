name: CI/CD Workflow

on:
  workflow_dispatch:
  push:
    branches:
      - release/*
    tags:
      - "[0-9]+.[0-9]+.[0-9]+"
      - "[0-9]+.[0-9]+"

permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  generate-version:
    runs-on: ubuntu-latest
    outputs:
      NEW_VERSION: ${{ steps.generate_new_version.outputs.NEW_VERSION }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
      - name: Extract short SHA
        id: vars
        run: echo "SHA_SHORT=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_ENV
      - name: generate new version
        id: generate_new_version
        run: |
          APP_VERSION=$(jq -r .version version.json)
          echo "BRANCH=${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}" >> $GITHUB_OUTPUT
          if [[ "$GITHUB_REF_NAME" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            NEW_VERSION="${GITHUB_REF_NAME}"
          else
            NEW_VERSION=$(echo "$APP_VERSION-${{github.run_number}}-${SHA_SHORT}")
          fi
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "::set-output name=NEW_VERSION::$NEW_VERSION"

      - name: Check NEW_VERSION
        run: echo "NEW_VERSION is ${{ steps.generate_new_version.outputs.NEW_VERSION }} on branch ${{ steps.generate_new_version.outputs.branch }}"

  docker-build-and-push:
    uses: Biolevate/biolevops-workflows/.github/workflows/docker-build-push.yml@main
    with:
      GITHUB_SHA: "${{ github.sha }}"
      REPOSITORY_NAME: "processor-forge"
      REPOSITORIES: "processor-forge,py-standards"
    secrets: inherit

  helm-build-and-push:
    uses: Biolevate/biolevops-workflows/.github/workflows/helm-build-push.yml@main
    with:
      GITHUB_SHA: "${{ github.sha }}"
      REPOSITORY_NAME: "processor-forge"
    secrets: inherit

  helm-deploy:
    needs:
      - generate-version
      - helm-build-and-push
      - docker-build-and-push
    uses: Biolevate/biolevops-workflows/.github/workflows/helm-deploy.yml@main
    with:
      REPOSITORY_NAME: "processor-forge"
      NEW_VERSION: ${{ needs.generate-version.outputs.NEW_VERSION }}
    secrets: inherit

  manage-version:
    needs:
      - generate-version
      - helm-build-and-push
      - docker-build-and-push
    uses: Biolevate/biolevops-workflows/.github/workflows/version.yml@main
    with:
      APPLICATION: "processor-forge"
      NEW_VERSION: "${{ needs.generate-version.outputs.NEW_VERSION }}"

  notify-slack-on-error:
    needs:
      - generate-version
      - helm-build-and-push
      - helm-deploy
      - docker-build-and-push
    if: failure()
    uses: Biolevate/biolevops-workflows/.github/workflows/notify-slack.yml@main
    with:
      CHANNEL: "tech-team"
      TITLE: "ðŸš¨ Le build *processor-forge* a Ã©chouÃ© ! ðŸš¨"
      TEXT: "DÃ©tails du build : <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}>|Cliquez ici pour voir> <!channel> @devs"
      COLOR: "danger"
